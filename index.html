<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Vacation Planner</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Auth Section -->
        <div id="auth-section">
            <div class="auth-container">
                <h1>üèñÔ∏è Family Vacation Planner</h1>
                <p class="auth-instructions">Enter your email and password below</p>
                <div id="login-form">
                    <input type="email" id="email" placeholder="your.email@example.com" required>
                    <input type="password" id="password" placeholder="Password (min 6 characters)" required>
                    <div class="button-group">
                        <button id="login-btn">Sign In</button>
                        <button id="signup-btn" class="secondary">Create Account</button>
                    </div>
                    <p class="auth-help">First time? Click "Create Account" ‚Ä¢ Returning? Click "Sign In"</p>
                </div>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="main-section" style="display: none;">
            <header>
                <h1>üèñÔ∏è Family Vacation Ideas</h1>
                <button id="logout-btn" class="logout">Sign Out</button>
            </header>

            <main>
                <!-- Add Vacation Form -->
                <div class="add-vacation-card">
                    <h2>Add a Vacation Idea</h2>
                    <form id="add-vacation-form">
                        <input type="text" id="vacation-title" placeholder="Vacation title *" required>
                        <input type="url" id="vacation-link" placeholder="Link (optional)">
                        <select id="vacation-month" required>
                            <option value="">Select preferred month *</option>
                            <option value="any">Any month (don't care)</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                        <button type="submit">Add Vacation Idea</button>
                    </form>
                </div>

                <!-- Vacation List -->
                <div class="vacations-container">
                    <h2>Vacation Ideas</h2>
                    <div id="vacations-list">
                        <!-- Vacations will be loaded here -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase SDKs (compat version for better iOS support) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Load config -->
    <script src="config.js"></script>

    <!-- App JavaScript -->
    <script>
        // Initialize Firebase
        const app = firebase.initializeApp(window.firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const mainSection = document.getElementById('main-section');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const addVacationForm = document.getElementById('add-vacation-form');
        const vacationsList = document.getElementById('vacations-list');

        let currentUser = null;

        // Auth State Observer
        auth.onAuthStateChanged(function(user) {
            if (user) {
                currentUser = user;
                authSection.style.display = 'none';
                mainSection.style.display = 'block';
                loadVacations();
            } else {
                currentUser = null;
                authSection.style.display = 'block';
                mainSection.style.display = 'none';
            }
        });

        // Sign Up
        signupBtn.addEventListener('click', function() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email) {
                alert('Please enter an email address');
                return;
            }

            if (!password) {
                alert('Please enter a password');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(function() {
                    alert('Account created successfully!');
                    emailInput.value = '';
                    passwordInput.value = '';
                })
                .catch(function(error) {
                    let errorMessage = error.message;
                    if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Please enter a valid email address (e.g., user@example.com)';
                    } else if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'This email is already registered. Try signing in instead.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak. Use at least 6 characters.';
                    }
                    alert('Error: ' + errorMessage);
                });
        });

        // Sign In
        loginBtn.addEventListener('click', function() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email) {
                alert('Please enter an email address');
                return;
            }

            if (!password) {
                alert('Please enter a password');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .catch(function(error) {
                    let errorMessage = error.message;
                    if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Please enter a valid email address';
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No account found with this email. Try signing up first.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password. Please try again.';
                    } else if (error.code === 'auth/invalid-credential') {
                        errorMessage = 'Invalid email or password. Please check and try again.';
                    }
                    alert('Error: ' + errorMessage);
                });
        });

        // Sign Out
        logoutBtn.addEventListener('click', function() {
            auth.signOut().catch(function(error) {
                alert('Error: ' + error.message);
            });
        });

        // Add Vacation
        addVacationForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const title = document.getElementById('vacation-title').value;
            const link = document.getElementById('vacation-link').value;
            const month = document.getElementById('vacation-month').value;

            db.collection('vacations').add({
                title: title,
                link: link || null,
                preferredMonth: month,
                createdBy: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                votes: [],
                voteCount: 0
            }).then(function() {
                addVacationForm.reset();
            }).catch(function(error) {
                alert('Error adding vacation: ' + error.message);
            });
        });

        // Load Vacations with Real-time Updates
        function loadVacations() {
            db.collection('vacations')
                .orderBy('voteCount', 'desc')
                .onSnapshot(function(snapshot) {
                    vacationsList.innerHTML = '';

                    if (snapshot.empty) {
                        vacationsList.innerHTML = '<div class="empty-state">No vacation ideas yet. Add one above!</div>';
                        return;
                    }

                    snapshot.forEach(function(doc) {
                        const vacation = doc.data();
                        const vacationEl = createVacationElement(doc.id, vacation);
                        vacationsList.appendChild(vacationEl);
                    });
                });
        }

        // Create Vacation Element
        function createVacationElement(id, vacation) {
            const div = document.createElement('div');
            div.className = 'vacation-item';

            const hasVoted = vacation.votes && vacation.votes.includes(currentUser.email);
            const voteCount = vacation.voteCount || 0;
            const isOwnIdea = vacation.createdBy === currentUser.email;

            const titleHTML = vacation.link
                ? '<a href="' + vacation.link + '" target="_blank" rel="noopener noreferrer">' + vacation.title + '</a>'
                : vacation.title;

            const monthDisplay = vacation.preferredMonth === 'any'
                ? 'Any month'
                : vacation.preferredMonth;

            // Determine vote button content
            let voteButtonHTML;
            if (isOwnIdea) {
                voteButtonHTML = '<button class="vote-btn" disabled>Your Idea</button>' +
                    '<div class="vote-count">' + voteCount + ' vote' + (voteCount !== 1 ? 's' : '') + '</div>';
            } else {
                voteButtonHTML = '<button class="vote-btn ' + (hasVoted ? 'voted' : '') + '" data-id="' + id + '">' +
                    (hasVoted ? '‚úì Voted' : 'Vote') +
                    '</button>' +
                    '<div class="vote-count">' + voteCount + ' vote' + (voteCount !== 1 ? 's' : '') + '</div>';
            }

            div.innerHTML = '<div class="vacation-header">' +
                '<div class="vacation-info">' +
                '<div class="vacation-title">' + titleHTML + '</div>' +
                '<div class="vacation-meta">' +
                '<div class="vacation-month">' +
                '<span>üìÖ</span>' +
                '<span>' + monthDisplay + '</span>' +
                '</div>' +
                '<div class="vacation-author">' +
                '<span>üë§</span>' +
                '<span>' + vacation.createdBy + '</span>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div class="vote-section">' +
                voteButtonHTML +
                '</div>' +
                '</div>';

            // Add vote button listener (only if not own idea)
            if (!isOwnIdea) {
                const voteBtn = div.querySelector('.vote-btn');
                voteBtn.addEventListener('click', function() {
                    toggleVote(id, hasVoted);
                });
            }

            return div;
        }

        // Toggle Vote
        function toggleVote(vacationId, hasVoted) {
            const vacationRef = db.collection('vacations').doc(vacationId);

            vacationRef.get().then(function(doc) {
                const currentVotes = doc.data().votes || [];

                let newVotes;
                if (hasVoted) {
                    newVotes = currentVotes.filter(function(email) {
                        return email !== currentUser.email;
                    });
                } else {
                    newVotes = currentVotes.concat([currentUser.email]);
                }

                return vacationRef.update({
                    votes: newVotes,
                    voteCount: newVotes.length
                });
            }).catch(function(error) {
                alert('Error voting: ' + error.message);
            });
        }
    </script>
</body>
</html>
